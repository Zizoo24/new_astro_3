---
/**
 * TableOfContents.astro
 * Sticky table of contents with jump links for in-page navigation
 * 
 * Usage:
 * <TableOfContents headings={[
 *   { id: "overview", text: "Overview", level: 2 },
 *   { id: "requirements", text: "Requirements", level: 2 },
 *   { id: "process", text: "Process", level: 2 }
 * ]} />
 */

interface Heading {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings: Heading[];
  title?: string;
  sticky?: boolean;
}

const { 
  headings, 
  title = "On This Page",
  sticky = true 
} = Astro.props;
---

{headings.length > 0 && (
  <nav class={`toc ${sticky ? 'toc-sticky' : ''}`} aria-labelledby="toc-title">
    <h4 id="toc-title" class="toc-title">
      <i class="fas fa-list"></i>
      {title}
    </h4>
    
    <ul class="toc-list">
      {headings.map((heading) => (
        <li class={`toc-item toc-level-${heading.level}`}>
          <a href={`#${heading.id}`} class="toc-link">
            <span class="toc-indicator"></span>
            {heading.text}
          </a>
        </li>
      ))}
    </ul>

    <a href="#top" class="toc-back-to-top">
      <i class="fas fa-arrow-up"></i>
      Back to Top
    </a>
  </nav>
)}

<style>
  .toc {
    background: var(--surface-secondary, #f8f9fa);
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin-bottom: 2rem;
  }

  .toc-sticky {
    position: sticky;
    top: 100px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }

  .toc-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--primary-navy, #0E2B48);
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-light, #e5e7eb);
  }

  .toc-title i {
    color: var(--accent-coral, #FF1654);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.25rem;
  }

  .toc-level-3 {
    padding-left: 1rem;
  }

  .toc-level-4 {
    padding-left: 2rem;
  }

  .toc-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: var(--text-muted, #5a6a7a);
    text-decoration: none;
    font-size: 0.9rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
    line-height: 1.4;
  }

  .toc-link:hover {
    color: var(--primary-navy, #0E2B48);
    background: rgba(14, 43, 72, 0.05);
  }

  .toc-link.active {
    color: var(--accent-coral, #FF1654);
    background: rgba(255, 22, 84, 0.08);
    font-weight: 600;
  }

  .toc-indicator {
    width: 3px;
    height: 3px;
    background: currentColor;
    border-radius: 50%;
    opacity: 0.5;
    flex-shrink: 0;
  }

  .toc-link.active .toc-indicator {
    width: 4px;
    height: 4px;
    background: var(--accent-coral, #FF1654);
    opacity: 1;
  }

  .toc-back-to-top {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.75rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-muted, #5a6a7a);
    text-decoration: none;
    border-top: 1px solid var(--border-light, #e5e7eb);
    transition: color 0.2s ease;
  }

  .toc-back-to-top:hover {
    color: var(--accent-coral, #FF1654);
  }

  @media (max-width: 1024px) {
    .toc-sticky {
      position: relative;
      top: 0;
      max-height: none;
    }
  }

  @media (max-width: 768px) {
    .toc {
      padding: 1rem;
    }

    .toc-link {
      padding: 0.4rem 0.5rem;
      font-size: 0.85rem;
    }
  }

  :global(body.theme-dark) .toc {
    background: rgba(22, 27, 34, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
  }

  :global(body.theme-dark) .toc-title {
    color: #e6edf3;
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  :global(body.theme-dark) .toc-link {
    color: #8b949e;
  }

  :global(body.theme-dark) .toc-link:hover {
    color: #e6edf3;
    background: rgba(255, 255, 255, 0.05);
  }

  :global(body.theme-dark) .toc-link.active {
    color: var(--accent-coral, #FF1654);
    background: rgba(255, 22, 84, 0.15);
  }

  :global(body.theme-dark) .toc-back-to-top {
    color: #8b949e;
    border-top-color: rgba(255, 255, 255, 0.1);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = Array.from(tocLinks).map(link => {
      const id = link.getAttribute('href')?.replace('#', '');
      return id ? document.getElementById(id) : null;
    }).filter(Boolean);

    const observerOptions = {
      rootMargin: '-100px 0px -66%',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.toc-link[href="#${entry.target.id}"]`);
          if (activeLink) activeLink.classList.add('active');
        }
      });
    }, observerOptions);

    headings.forEach(heading => {
      if (heading) observer.observe(heading);
    });

    tocLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const id = link.getAttribute('href')?.replace('#', '');
        const target = id ? document.getElementById(id) : null;
        if (target) {
          const offset = 80;
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: 'smooth' });
          history.pushState(null, '', `#${id}`);
        }
      });
    });
  });
</script>
