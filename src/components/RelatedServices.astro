---
/**
 * RelatedServices.astro
 * "You May Also Need" section for near-extreme internal linking
 * 
 * Usage:
 * <RelatedServices pageKey="birthCertificate" />
 * <RelatedServices pageKey="goldenVisa" showPrerequisites={true} />
 */
import {
  getRelatedServices,
  getFamilyDocuments,
  getPrerequisites,
  getNextSteps,
  getCrossLinks
} from '../data/serviceLinks';

interface Props {
  pageKey: string;
  title?: string;
  showFamily?: boolean;
  showPrerequisites?: boolean;
  showNextSteps?: boolean;
  showCrossSilo?: boolean;
  maxItems?: number;
}

const { 
  pageKey, 
  title = "You May Also Need",
  showFamily = true,
  showPrerequisites = false,
  showNextSteps = true,
  showCrossSilo = false,
  maxItems = 6
} = Astro.props;

const related = getRelatedServices(pageKey, maxItems);
const family = showFamily ? getFamilyDocuments(pageKey) : [];
const prerequisites = showPrerequisites ? getPrerequisites(pageKey) : [];
const nextSteps = showNextSteps ? getNextSteps(pageKey) : [];
const crossSilo = showCrossSilo ? getCrossLinks(pageKey) : [];

const allLinks = [
  ...prerequisites.map(l => ({ ...l, category: 'prerequisite' })),
  ...related.map(l => ({ ...l, category: 'related' })),
  ...family.map(l => ({ ...l, category: 'family' })),
  ...nextSteps.map(l => ({ ...l, category: 'next' })),
  ...crossSilo.map(l => ({ ...l, category: 'cross' }))
];

const uniqueLinks = allLinks
  .filter((link, index, self) => 
    self.findIndex(l => l.url === link.url) === index
  )
  .slice(0, maxItems);
---

{uniqueLinks.length > 0 && (
  <section class="related-services" aria-labelledby="related-heading">
    <h3 id="related-heading" class="related-title">
      <i class="fas fa-link"></i>
      {title}
    </h3>
    
    <div class="related-grid">
      {uniqueLinks.map((link) => (
        <a href={link.url} class={`related-card ${link.category}`}>
          {link.icon && <i class={link.icon}></i>}
          <span class="related-text">{link.full || link.text}</span>
          {link.badge && <span class="related-badge">{link.badge}</span>}
          <i class="fas fa-arrow-right related-arrow"></i>
        </a>
      ))}
    </div>

    {showPrerequisites && prerequisites.length > 0 && (
      <div class="prerequisites-note">
        <i class="fas fa-info-circle"></i>
        <span>These documents are typically needed before proceeding</span>
      </div>
    )}
  </section>
)}

<style>
  .related-services {
    margin: 3rem 0;
    padding: 2rem;
    background: var(--surface-secondary, #f8f9fa);
    border-radius: 1rem;
    border-left: 4px solid var(--accent-coral, #FF1654);
  }

  .related-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-navy, #0E2B48);
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .related-title i {
    color: var(--accent-coral, #FF1654);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
  }

  .related-card {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    background: white;
    border-radius: 0.75rem;
    text-decoration: none;
    color: #1a1a1a !important; /* Override global white link color */
    border: 1px solid var(--border-light, #e5e7eb);
    transition: all 0.3s ease;
    position: relative;
  }

  .related-card:hover {
    border-color: var(--accent-coral, #FF1654);
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .related-card i:first-child {
    font-size: 1.25rem;
    color: var(--primary-navy, #0E2B48);
    min-width: 24px;
    text-align: center;
  }

  .related-text {
    flex: 1;
    font-weight: 500;
    line-height: 1.3;
    color: #1a1a1a !important; /* Explicit text color - override white link */
  }

  .related-arrow {
    font-size: 0.75rem;
    color: var(--text-muted, #5a6a7a);
    opacity: 0;
    transform: translateX(-8px);
    transition: all 0.3s ease;
  }

  .related-card:hover .related-arrow {
    opacity: 1;
    transform: translateX(0);
    color: var(--accent-coral, #FF1654);
  }

  .related-badge {
    position: absolute;
    top: -6px;
    right: 8px;
    font-size: 0.65rem;
    font-weight: 700;
    padding: 2px 8px;
    background: var(--accent-coral, #FF1654);
    color: white;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .related-card.prerequisite {
    border-left: 3px solid var(--gold, #d4a54c);
  }

  .related-card.next {
    border-left: 3px solid var(--accent-coral, #FF1654);
  }

  .prerequisites-note {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding: 0.75rem 1rem;
    background: rgba(212, 165, 76, 0.1);
    border-radius: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-muted, #5a6a7a);
  }

  .prerequisites-note i {
    color: var(--gold, #d4a54c);
  }

  @media (max-width: 768px) {
    .related-services {
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .related-title {
      font-size: 1.1rem;
    }
  }

  :global(body.theme-dark) .related-services {
    background: rgba(14, 43, 72, 0.3);
    border-left-color: var(--accent-coral, #FF1654);
  }

  :global(body.theme-dark) .related-title {
    color: #e6edf3;
  }

  :global(body.theme-dark) .related-card {
    background: rgba(22, 27, 34, 0.8);
    border-color: rgba(255, 255, 255, 0.1);
    color: #e6edf3 !important; /* Override global white link color */
  }

  :global(body.theme-dark) .related-card:hover {
    border-color: var(--accent-coral, #FF1654);
  }

  :global(body.theme-dark) .related-card i:first-child {
    color: #8b949e;
  }

  :global(body.theme-dark) .related-text {
    color: #e6edf3 !important; /* Dark mode text color */
  }
</style>
