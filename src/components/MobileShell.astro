---
/**
 * MobileShell.astro - Mobile Navigation (Sidebar, Bottom Bar, Search)
 * Uses navigation.ts as single source of truth
 */
import { mobileNav, searchQuickLinks, siteContact } from '../data/navigation';
---

<!-- Mobile Top Header - Only visible on mobile -->
<div class="header-mobile">
  <button type="button" class="header-icon" id="sidebarToggle" aria-label="Open menu">
    <i class="fas fa-bars"></i>
  </button>
  <a href="/" class="header-title">OnlineTranslation<span>.ae</span></a>
  <button type="button" id="mobileThemeToggle" class="header-icon" aria-label="Toggle theme">
    <i class="fas fa-moon"></i>
  </button>
</div>

<!-- Mobile Bottom Navigation -->
<div id="footer-bar" class="footer-bar">
  <button type="button" class="footer-item active-nav" id="footerMenuToggle">
    <i class="fas fa-bars"></i>
    <span>Menu</span>
  </button>
  <button type="button" class="footer-item" id="searchToggle">
    <i class="fas fa-search"></i>
    <span>Search</span>
  </button>
  <a href={siteContact.whatsapp} class="footer-item footer-whatsapp">
    <i class="fab fa-whatsapp"></i>
    <span>WhatsApp</span>
  </a>
  <a href={`tel:${siteContact.phone}`} class="footer-item">
    <i class="fas fa-phone"></i>
    <span>Call</span>
  </a>
  <a href="/contact/" class="footer-item">
    <i class="fas fa-envelope"></i>
    <span>Contact</span>
  </a>
</div>

<!-- Mobile Sidebar -->
<nav id="menu-sidebar" class="sidebar-menu" aria-label="Mobile navigation">
  <div class="sidebar-header">
    <a href="/" class="sidebar-logo">
      <img src="/images/logo/brand/emblem-256.png" alt="OnlineTranslation.ae" class="sidebar-emblem" loading="lazy">
      <div class="sidebar-brand">
        <span class="sidebar-brand-name">Online<span class="brand-suffix">Translation.ae</span></span>
        <span class="sidebar-tagline">Boutique Legal Translation</span>
      </div>
    </a>
    <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="sidebar-nav">
    <!-- Home Link -->
    <a href={mobileNav.home.href} class="sidebar-home-link">
      <i class={mobileNav.home.icon}></i> {mobileNav.home.label}
    </a>
    
    <!-- Accordion Groups -->
    {mobileNav.accordions.map((accordion) => (
      <div class="sidebar-accordion-group" data-accordion={accordion.id}>
        <button 
          class="sidebar-accordion-heading" 
          aria-expanded="false" 
          aria-controls={`accordion-${accordion.id}`}
        >
          <span class="heading-text">{accordion.label}</span>
          <i class="fas fa-chevron-down accordion-chevron"></i>
        </button>
        <div class="sidebar-accordion-panel" id={`accordion-${accordion.id}`}>
          {accordion.children.map((child) => (
            <a href={child.href}>{child.label}</a>
          ))}
          <a href={accordion.href} class="sidebar-viewall">
            View all {accordion.label.toLowerCase()} <i class="fas fa-arrow-right"></i>
          </a>
        </div>
      </div>
    ))}
    
    <!-- Single Links -->
    {mobileNav.singleLinks.map((link) => (
      <a href={link.href} class="sidebar-single-link">
        <i class={link.icon}></i> {link.label}
      </a>
    ))}
  </div>
  <div class="sidebar-contact">
    <a href={siteContact.whatsapp} class="sidebar-cta">
      <i class="fab fa-whatsapp"></i> WhatsApp Us
    </a>
    <a href={`tel:${siteContact.phone}`} class="sidebar-cta secondary">
      <i class="fas fa-phone"></i> {siteContact.phoneDisplay}
    </a>
  </div>
</nav>

<!-- Search Overlay -->
<div id="search-overlay" class="search-overlay">
  <div class="search-container">
    <button class="search-close" id="searchClose" aria-label="Close search">
      <i class="fas fa-times"></i>
    </button>
    <h3>Search Services</h3>
    <div class="search-box">
      <input type="text" placeholder="What are you looking for?" id="searchInput" aria-label="Search">
      <button class="search-btn" aria-label="Search"><i class="fas fa-search"></i></button>
    </div>
    <div id="searchResults" class="search-results"></div>
    <div class="quick-links">
      <span>Popular:</span>
      {searchQuickLinks.map((link) => (
        <a href={link.href}>{link.label}</a>
      ))}
    </div>
  </div>
</div>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Back to Top Button -->
<button id="backToTop" class="back-to-top" aria-label="Back to top">
  <i class="fas fa-chevron-up"></i>
</button>

<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  const footerMenuToggle = document.getElementById('footerMenuToggle');
  const sidebarClose = document.getElementById('sidebarClose');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const menuSidebar = document.getElementById('menu-sidebar');
  const searchToggle = document.getElementById('searchToggle');
  const searchClose = document.getElementById('searchClose');
  const searchOverlay = document.getElementById('search-overlay');
  const backToTop = document.getElementById('backToTop');
  
  // Expand Services by default when sidebar opens
  function expandServicesDefault() {
    // Close all first
    document.querySelectorAll('.sidebar-accordion-panel').forEach(function(el) {
      el.classList.remove('is-open');
    });
    document.querySelectorAll('.sidebar-accordion-heading').forEach(function(el) {
      el.classList.remove('is-open');
      el.setAttribute('aria-expanded', 'false');
    });
    // Expand Services
    const servicesPanel = document.getElementById('accordion-services');
    const servicesHeading = document.querySelector('.sidebar-accordion-group[data-accordion="services"] .sidebar-accordion-heading');
    if (servicesPanel && servicesHeading) {
      servicesPanel.classList.add('is-open');
      servicesHeading.classList.add('is-open');
      servicesHeading.setAttribute('aria-expanded', 'true');
    }
  }
  
  function openSidebar() {
    menuSidebar?.classList.add('is-open');
    sidebarOverlay?.classList.add('is-visible');
    document.body.style.overflow = 'hidden';
    // Always expand Services when sidebar opens
    expandServicesDefault();
  }
  
  // Watch for sidebar open from ANY source (including navigation-v2.js)
  if (menuSidebar) {
    const sidebarObserver = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.attributeName === 'class') {
          const isOpen = menuSidebar.classList.contains('is-open');
          if (isOpen) {
            // Delay slightly to ensure DOM is ready
            setTimeout(expandServicesDefault, 10);
          }
        }
      });
    });
    sidebarObserver.observe(menuSidebar, { attributes: true, attributeFilter: ['class'] });
  }
  
  function closeSidebar() {
    menuSidebar?.classList.remove('is-open');
    sidebarOverlay?.classList.remove('is-visible');
    document.body.style.overflow = '';
  }
  
  function openSearch() {
    searchOverlay?.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    document.getElementById('searchInput')?.focus();
  }
  
  function closeSearch() {
    searchOverlay?.classList.remove('is-open');
    document.body.style.overflow = '';
  }
  
  footerMenuToggle?.addEventListener('click', function(e) {
    e.preventDefault();
    openSidebar();
  });
  
  sidebarClose?.addEventListener('click', closeSidebar);
  sidebarOverlay?.addEventListener('click', closeSidebar);
  
  searchToggle?.addEventListener('click', function(e) {
    e.preventDefault();
    openSearch();
  });
  
  searchClose?.addEventListener('click', closeSearch);
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeSidebar();
      closeSearch();
    }
  });
  
  // Sidebar accordion - proper toggle behavior
  const accordionHeadings = document.querySelectorAll('.sidebar-accordion-heading');
  
  function toggleAccordion(heading) {
    const group = heading.closest('.sidebar-accordion-group');
    const accordionId = group?.getAttribute('data-accordion');
    const panel = document.getElementById('accordion-' + accordionId);
    const isExpanded = heading.getAttribute('aria-expanded') === 'true';
    
    // Close all other accordions
    document.querySelectorAll('.sidebar-accordion-panel').forEach(function(el) {
      el.classList.remove('is-open');
    });
    accordionHeadings.forEach(function(el) {
      el.classList.remove('is-open');
      el.setAttribute('aria-expanded', 'false');
    });
    
    // Toggle current (if wasn't expanded, expand it)
    if (!isExpanded) {
      panel?.classList.add('is-open');
      heading.classList.add('is-open');
      heading.setAttribute('aria-expanded', 'true');
    }
  }
  
  accordionHeadings.forEach(function(heading) {
    heading.addEventListener('click', function(e) {
      e.preventDefault();
      toggleAccordion(heading);
    });
    
    // Keyboard support
    heading.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleAccordion(heading);
      }
    });
  });
  
  // Expand Services on initial page load
  expandServicesDefault();
  
  // Back to top
  window.addEventListener('scroll', function() {
    if (window.pageYOffset > 300) {
      backToTop?.classList.add('is-visible');
    } else {
      backToTop?.classList.remove('is-visible');
    }
  });
  
  backToTop?.addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Mobile Theme Toggle
  const mobileThemeToggle = document.getElementById('mobileThemeToggle');

  function updateMobileThemeIcon() {
    if (!mobileThemeToggle) return;
    const isDark = document.body.classList.contains('theme-dark');
    const icon = mobileThemeToggle.querySelector('i');
    if (icon) {
      icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
    }
  }

  if (mobileThemeToggle) {
    mobileThemeToggle.addEventListener('click', function(e) {
      e.preventDefault();
      const html = document.documentElement;
      const body = document.body;
      const isDark = body.classList.contains('theme-dark');

      if (isDark) {
        body.classList.remove('theme-dark');
        body.classList.add('theme-light');
        html.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      } else {
        body.classList.remove('theme-light');
        body.classList.add('theme-dark');
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }

      updateMobileThemeIcon();
    });

    // Set initial icon state
    updateMobileThemeIcon();
  }
});
</script>