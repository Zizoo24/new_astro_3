---
/**
 * MobileShell.astro - Mobile Navigation (Sidebar, Bottom Bar, Search)
 * Uses navigation.ts as single source of truth
 * 
 * UPDATED: Dec 2024
 * - All accordions COLLAPSED by default (no auto-expand)
 * - Hub-based navigation (3-5 items per section)
 * - Works with existing sticky-mobile.css dark theme
 */
import { mobileNavHubs, searchQuickLinks, siteContact } from '../data/navigation';
---

<!-- Mobile Top Header - Only visible on mobile -->
<div class="header-mobile">
  <button type="button" class="header-icon" id="sidebarToggle" aria-label="Open menu">
    <i class="fas fa-bars"></i>
  </button>
  <a href="/" class="header-title">OnlineTranslation<span>.ae</span></a>
  <button type="button" id="mobileThemeToggle" class="header-icon" aria-label="Toggle theme">
    <i class="fas fa-moon"></i>
  </button>
</div>

<!-- Mobile Bottom Navigation -->
<div id="footer-bar" class="footer-bar">
  <button type="button" class="footer-item active-nav" id="footerMenuToggle">
    <i class="fas fa-bars"></i>
    <span>Menu</span>
  </button>
  <button type="button" class="footer-item" id="searchToggle">
    <i class="fas fa-search"></i>
    <span>Search</span>
  </button>
  <a href={siteContact.whatsapp} class="footer-item footer-whatsapp">
    <i class="fab fa-whatsapp"></i>
    <span>WhatsApp</span>
  </a>
  <a href={`tel:${siteContact.phone}`} class="footer-item">
    <i class="fas fa-phone"></i>
    <span>Call</span>
  </a>
  <a href="/contact/" class="footer-item">
    <i class="fas fa-envelope"></i>
    <span>Contact</span>
  </a>
</div>

<!-- Mobile Sidebar -->
<nav id="menu-sidebar" class="sidebar-menu" aria-label="Mobile navigation">
  <div class="sidebar-header">
    <a href="/" class="sidebar-logo">
      <img src="/assets/images/logo/brand/emblem-256.png" alt="OnlineTranslation.ae" class="sidebar-emblem" loading="lazy" width="48" height="48">
      <div class="sidebar-brand">
        <span class="sidebar-brand-name">Online<span class="brand-suffix">Translation.ae</span></span>
        <span class="sidebar-tagline">Boutique Legal Translation</span>
      </div>
    </a>
    <button class="sidebar-close" id="sidebarClose" aria-label="Close menu">
      <i class="fas fa-times"></i>
    </button>
  </div>
  
  <div class="sidebar-nav">
    <!-- Home Link -->
    <a href="/" class="sidebar-home-link">
      <i class="fas fa-home"></i> Home
    </a>
    
    <!-- Hub-Based Accordion Groups (3-5 items each) -->
    {mobileNavHubs.map((accordion) => (
      <div class="sidebar-accordion-group" data-accordion={accordion.id}>
        <button 
          class="sidebar-accordion-heading" 
          aria-expanded="false" 
          aria-controls={`accordion-${accordion.id}`}
        >
          <span class="heading-text">
            {accordion.icon && <i class={accordion.icon} style="margin-right: 8px; color: var(--accent-color);"></i>}
            {accordion.label}
          </span>
          <i class="fas fa-chevron-down accordion-chevron"></i>
        </button>
        <div class="sidebar-accordion-panel" id={`accordion-${accordion.id}`}>
          {/* Hub link first - highlighted */}
          <a href={accordion.href} class="sidebar-hub-link">
            <i class="fas fa-th-large"></i> {accordion.hubLabel || `All ${accordion.label}`}
          </a>
          {/* Key sub-links (3-4 max) */}
          {accordion.children.map((child) => (
            <a href={child.href}>
              {child.icon && <i class={child.icon} style="width: 16px; margin-right: 6px; opacity: 0.7;"></i>}
              {child.label}
            </a>
          ))}
        </div>
      </div>
    ))}
    
    <!-- Single Links -->
    <a href="/about/" class="sidebar-single-link">
      <i class="fas fa-building"></i> About & Licensing
    </a>
    <a href="/contact/" class="sidebar-single-link">
      <i class="fas fa-envelope"></i> Contact Us
    </a>
  </div>
  
  <div class="sidebar-contact">
    <a href={siteContact.whatsapp} class="sidebar-cta">
      <i class="fab fa-whatsapp"></i> WhatsApp Us
    </a>
    <a href={`tel:${siteContact.phone}`} class="sidebar-cta secondary">
      <i class="fas fa-phone"></i> {siteContact.phoneDisplay}
    </a>
  </div>
</nav>

<!-- Search Overlay - Pagefind -->
<div id="search-overlay" class="search-overlay">
  <div class="search-container">
    <button class="search-close" id="searchClose" aria-label="Close search">
      <i class="fas fa-times"></i>
    </button>
    <h3>Search Services</h3>
    <div id="pagefind-container"></div>
    <div class="quick-links">
      <span>Popular:</span>
      {searchQuickLinks.map((link) => (
        <a href={link.href}>{link.label}</a>
      ))}
    </div>
  </div>
</div>

<!-- Pagefind CSS -->
<link href="/pagefind/pagefind-ui.css" rel="stylesheet">

<!-- Pagefind UI Script -->
<script is:inline>
  window.addEventListener('DOMContentLoaded', function() {
    // Load Pagefind UI dynamically
    var script = document.createElement('script');
    script.src = '/pagefind/pagefind-ui.js';
    script.onload = function() {
      if (typeof PagefindUI !== 'undefined') {
        new PagefindUI({
          element: "#pagefind-container",
          showSubResults: true,
          showImages: false,
          excerptLength: 15,
          resetStyles: false
        });
      }
    };
    document.head.appendChild(script);
  });
</script>

<style is:global>
  /* Pagefind UI Customization */
  #pagefind-container {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: #FF1654;
    --pagefind-ui-text: #ffffff;
    --pagefind-ui-background: #0E2B48;
    --pagefind-ui-border: rgba(255, 255, 255, 0.2);
    --pagefind-ui-tag: #FF1654;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: inherit;
  }

  .pagefind-ui__search-input {
    background: rgba(255, 255, 255, 0.1) !important;
    color: #ffffff !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important;
    padding: 14px 16px !important;
    font-size: 1rem !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: rgba(255, 255, 255, 0.6) !important;
  }

  .pagefind-ui__search-input:focus {
    border-color: #FF1654 !important;
    outline: none !important;
  }

  .pagefind-ui__result {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    padding: 12px !important;
    margin-bottom: 8px !important;
    border-radius: 8px !important;
  }

  .pagefind-ui__result:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    border-color: #FF1654 !important;
  }

  .pagefind-ui__result-link {
    color: #ffffff !important;
    font-weight: 600 !important;
    text-decoration: none !important;
  }

  .pagefind-ui__result-link:hover {
    color: #FF1654 !important;
  }

  .pagefind-ui__result-excerpt {
    color: rgba(255, 255, 255, 0.8) !important;
    font-size: 0.9rem !important;
  }

  .pagefind-ui__result-title {
    color: #ffffff !important;
  }

  .pagefind-ui__message {
    color: rgba(255, 255, 255, 0.7) !important;
  }

  .pagefind-ui__button {
    background: #FF1654 !important;
    color: #ffffff !important;
    border: none !important;
  }

  .pagefind-ui__button:hover {
    background: #e01349 !important;
  }

  /* Hide Pagefind branding */
  .pagefind-ui__suppressed {
    display: none !important;
  }
</style>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Back to Top Button -->
<button id="backToTop" class="back-to-top" aria-label="Back to top">
  <i class="fas fa-chevron-up"></i>
</button>

<style>
/* ============================================
   MOBILE MENU ACCESSIBILITY FIX
   Comprehensive contrast and UI improvements
   WCAG AA compliant (4.5:1 minimum contrast)
   ============================================ */

/* Force dark navy background on entire sidebar */
.sidebar-menu {
  background: #0E2B48 !important;
  --sidebar-text: #ffffff;
  --sidebar-text-muted: rgba(255, 255, 255, 0.9);
  --sidebar-accent: #FF1654;
}

/* Navigation area - ensure dark background inherited */
.sidebar-nav {
  background: transparent !important;
  padding: 16px 0 !important;
}

/* ============================================
   ACCORDION HEADINGS - High Contrast
   ============================================ */
.sidebar-accordion-heading {
  color: #ffffff !important;
  font-size: 0.95rem !important;
  font-weight: 700 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.05em !important;
  padding: 16px 20px !important;
  min-height: 56px !important; /* WCAG touch target */
}

.sidebar-accordion-heading:hover,
.sidebar-accordion-heading:focus,
.sidebar-accordion-heading:active,
.sidebar-accordion-heading.is-open {
  color: #ffffff !important;
  background: rgba(255, 255, 255, 0.08) !important;
}

/* Focus state for keyboard navigation */
.sidebar-accordion-heading:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: -2px !important;
}

.sidebar-accordion-heading .heading-text {
  color: #ffffff !important;
  display: flex !important;
  align-items: center !important;
}

/* Icons in accordion headings - larger, more visible */
.sidebar-accordion-heading .heading-text i {
  color: #FF1654 !important;
  font-size: 1.1rem !important;
  width: 24px !important;
  min-width: 24px !important;
}

/* Chevrons - MUCH more visible */
.sidebar-accordion-heading .accordion-chevron {
  color: #ffffff !important;
  opacity: 0.9 !important;
  font-size: 0.9rem !important;
  transition: transform 0.3s ease !important;
}

.sidebar-accordion-heading.is-open .accordion-chevron {
  transform: rotate(180deg) !important;
}

/* ============================================
   ACCORDION PANEL LINKS - High Contrast
   ============================================ */
.sidebar-accordion-panel {
  background: rgba(0, 0, 0, 0.2) !important;
}

.sidebar-accordion-panel a {
  color: #ffffff !important;
  font-size: 0.9rem !important;
  font-weight: 500 !important;
  padding: 14px 20px 14px 48px !important;
  min-height: 48px !important; /* WCAG touch target */
  display: flex !important;
  align-items: center !important;
}

.sidebar-accordion-panel a:hover,
.sidebar-accordion-panel a:focus,
.sidebar-accordion-panel a:active {
  color: #ffffff !important;
  background: rgba(255, 255, 255, 0.1) !important;
  border-left: 3px solid #FF1654 !important;
}

.sidebar-accordion-panel a:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: -2px !important;
}

/* Sub-link icons */
.sidebar-accordion-panel a i {
  color: rgba(255, 255, 255, 0.7) !important;
  font-size: 0.9rem !important;
  width: 20px !important;
  min-width: 20px !important;
}

/* Hub link styling - highlighted */
.sidebar-hub-link {
  display: flex !important;
  align-items: center !important;
  padding: 14px 20px 14px 32px !important;
  background: rgba(255, 22, 84, 0.15) !important;
  font-weight: 600 !important;
  font-size: 0.9rem !important;
  color: #ffffff !important;
  border-left: 3px solid #FF1654 !important;
  text-decoration: none !important;
  min-height: 48px !important;
}

.sidebar-hub-link:hover,
.sidebar-hub-link:focus {
  background: rgba(255, 22, 84, 0.25) !important;
  color: #ffffff !important;
}

.sidebar-hub-link i {
  color: #FF1654 !important;
  margin-right: 10px !important;
  width: 18px !important;
  font-size: 1rem !important;
}

/* ============================================
   HOME LINK - Prominent Active State
   ============================================ */
.sidebar-home-link {
  display: flex !important;
  align-items: center !important;
  gap: 14px !important;
  padding: 16px 20px !important;
  color: #ffffff !important;
  font-weight: 700 !important;
  font-size: 1rem !important;
  text-decoration: none !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15) !important;
  border-left: 3px solid #FF1654 !important;
  background: rgba(255, 22, 84, 0.1) !important;
  min-height: 56px !important;
}

.sidebar-home-link:hover,
.sidebar-home-link:focus,
.sidebar-home-link:active {
  background: rgba(255, 22, 84, 0.2) !important;
}

.sidebar-home-link:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: -2px !important;
}

.sidebar-home-link i {
  width: 24px !important;
  min-width: 24px !important;
  color: #FF1654 !important;
  font-size: 1.2rem !important;
}

/* ============================================
   SINGLE LINKS (About, Contact) - High Contrast
   ============================================ */
.sidebar-single-link {
  display: flex !important;
  align-items: center !important;
  gap: 14px !important;
  padding: 16px 20px !important;
  color: #ffffff !important;
  font-weight: 600 !important;
  font-size: 0.95rem !important;
  text-decoration: none !important;
  border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
  border-left: 3px solid transparent !important;
  min-height: 56px !important;
}

.sidebar-single-link:hover,
.sidebar-single-link:focus,
.sidebar-single-link:active {
  background: rgba(255, 255, 255, 0.08) !important;
  border-left-color: #FF1654 !important;
}

.sidebar-single-link:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: -2px !important;
}

.sidebar-single-link i {
  width: 24px !important;
  min-width: 24px !important;
  color: #FF1654 !important;
  font-size: 1.1rem !important;
}

/* ============================================
   SIDEBAR HEADER - Improved Spacing
   ============================================ */
.sidebar-header {
  padding: 20px !important;
  gap: 16px !important;
}

.sidebar-brand-name {
  color: #ffffff !important;
  font-size: 1.1rem !important;
}

.sidebar-brand-name .brand-suffix {
  color: #FF1654 !important;
}

.sidebar-tagline {
  color: rgba(255, 255, 255, 0.85) !important;
  font-size: 0.7rem !important;
  letter-spacing: 0.08em !important;
}

/* Close button - more visible */
.sidebar-close {
  background: rgba(255, 255, 255, 0.2) !important;
  color: #ffffff !important;
  width: 44px !important;
  height: 44px !important;
  min-width: 44px !important;
  min-height: 44px !important;
  font-size: 1.2rem !important;
}

.sidebar-close:hover,
.sidebar-close:focus {
  background: rgba(255, 255, 255, 0.3) !important;
}

.sidebar-close:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: 2px !important;
}

/* ============================================
   CTA SECTION - Phone as Button
   ============================================ */
.sidebar-contact {
  padding: 20px !important;
  border-top: 1px solid rgba(255, 255, 255, 0.15) !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 12px !important;
}

/* WhatsApp button - primary */
.sidebar-cta {
  color: #ffffff !important;
  font-weight: 600 !important;
  font-size: 1rem !important;
  padding: 16px 24px !important;
  border-radius: 12px !important;
  min-height: 56px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 12px !important;
}

.sidebar-cta i {
  font-size: 1.3rem !important;
}

/* Phone button - styled as secondary button */
.sidebar-cta.secondary {
  background: rgba(255, 255, 255, 0.15) !important;
  border: 2px solid rgba(255, 255, 255, 0.3) !important;
  color: #ffffff !important;
}

.sidebar-cta.secondary:hover,
.sidebar-cta.secondary:focus {
  background: rgba(255, 255, 255, 0.25) !important;
  border-color: rgba(255, 255, 255, 0.5) !important;
}

.sidebar-cta.secondary:focus-visible {
  outline: 2px solid #FF1654 !important;
  outline-offset: 2px !important;
}
</style>

<script is:inline>
document.addEventListener('DOMContentLoaded', function() {
  const footerMenuToggle = document.getElementById('footerMenuToggle');
  const sidebarClose = document.getElementById('sidebarClose');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const menuSidebar = document.getElementById('menu-sidebar');
  const searchToggle = document.getElementById('searchToggle');
  const searchClose = document.getElementById('searchClose');
  const searchOverlay = document.getElementById('search-overlay');
  const backToTop = document.getElementById('backToTop');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileThemeToggle = document.getElementById('mobileThemeToggle');

  // Ensure all accordions are COLLAPSED
  function closeAllAccordions() {
    document.querySelectorAll('.sidebar-accordion-panel').forEach(function(el) {
      el.classList.remove('is-open');
    });
    document.querySelectorAll('.sidebar-accordion-heading').forEach(function(el) {
      el.classList.remove('is-open');
      el.setAttribute('aria-expanded', 'false');
    });
  }
  
  function openSidebar() {
    if (menuSidebar) {
      menuSidebar.classList.add('is-open');
    }
    if (sidebarOverlay) {
      sidebarOverlay.classList.add('is-visible');
    }
    document.body.style.overflow = 'hidden';
    // ALL accordions stay COLLAPSED - no auto-expand
    closeAllAccordions();
  }

  // Mobile top header toggle
  if (sidebarToggle) {
    sidebarToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      openSidebar();
    });
  }

  // Mobile theme toggle
  if (mobileThemeToggle) {
    mobileThemeToggle.addEventListener('click', function(e) {
      e.preventDefault();
      var html = document.documentElement;
      var body = document.body;
      var currentTheme = html.getAttribute('data-theme') || 'light';
      var newTheme = currentTheme === 'dark' ? 'light' : 'dark';

      html.setAttribute('data-theme', newTheme);
      html.className = html.className.replace(/theme-\w+/, 'theme-' + newTheme);
      body.classList.remove('theme-light', 'theme-dark');
      body.classList.add('theme-' + newTheme);
      localStorage.setItem('theme', newTheme);

      var icon = mobileThemeToggle.querySelector('i');
      if (icon) {
        icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      }
    });
  }
  
  function closeSidebar() {
    menuSidebar?.classList.remove('is-open');
    sidebarOverlay?.classList.remove('is-visible');
    document.body.style.overflow = '';
  }
  
  function openSearch() {
    searchOverlay?.classList.add('is-open');
    document.body.style.overflow = 'hidden';
    document.getElementById('searchInput')?.focus();
  }
  
  function closeSearch() {
    searchOverlay?.classList.remove('is-open');
    document.body.style.overflow = '';
  }
  
  footerMenuToggle?.addEventListener('click', function(e) {
    e.preventDefault();
    openSidebar();
  });
  
  sidebarClose?.addEventListener('click', closeSidebar);
  sidebarOverlay?.addEventListener('click', closeSidebar);
  
  searchToggle?.addEventListener('click', function(e) {
    e.preventDefault();
    openSearch();
  });
  
  searchClose?.addEventListener('click', closeSearch);
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeSidebar();
      closeSearch();
    }
  });
  
  // Accordion toggle - one at a time, click to expand
  const accordionHeadings = document.querySelectorAll('.sidebar-accordion-heading');
  
  function toggleAccordion(heading) {
    const group = heading.closest('.sidebar-accordion-group');
    const accordionId = group?.getAttribute('data-accordion');
    const panel = document.getElementById('accordion-' + accordionId);
    const isExpanded = heading.getAttribute('aria-expanded') === 'true';
    
    // Close all others first
    document.querySelectorAll('.sidebar-accordion-panel').forEach(function(el) {
      el.classList.remove('is-open');
    });
    accordionHeadings.forEach(function(el) {
      el.classList.remove('is-open');
      el.setAttribute('aria-expanded', 'false');
    });
    
    // Toggle current (if wasn't expanded, expand it)
    if (!isExpanded) {
      panel?.classList.add('is-open');
      heading.classList.add('is-open');
      heading.setAttribute('aria-expanded', 'true');
    }
  }
  
  accordionHeadings.forEach(function(heading) {
    heading.addEventListener('click', function(e) {
      e.preventDefault();
      toggleAccordion(heading);
    });
    
    heading.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleAccordion(heading);
      }
    });
  });
  
  // Back to top
  window.addEventListener('scroll', function() {
    if (window.pageYOffset > 300) {
      backToTop?.classList.add('is-visible');
    } else {
      backToTop?.classList.remove('is-visible');
    }
  });
  
  backToTop?.addEventListener('click', function() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
});
</script>
